"""
==========================================
SOCIAL MEDIA POSTER - EVENT API ENDPOINTS  
==========================================
Bestandslocatie: backend/app/api/events.py
Full Path: C:/Users/DASAP/Documents/social_media_poster/backend/app/api/events.py

FastAPI routes voor event management
✅ OAUTH 2.0: Alle endpoints beveiligd met JWT authenticatie
✅ WORKSPACE ISOLATION: Users zien alleen events van hun workspace
✅ USER DRIVE: Elk gebruiker gebruikt zijn eigen Google Drive
"""

from fastapi import APIRouter, Depends, HTTPException, Query, status
from sqlalchemy.orm import Session
from sqlalchemy import func, or_
from typing import Optional, List
from uuid import UUID
from datetime import datetime

from ..core.database import get_db
from ..models.event import Event
from ..models.customer import Customer
from ..models.user import User
from ..models.workspace import Workspace
from ..schemas.event import (
    EventCreate,
    EventUpdate,
    EventResponse,
    EventSummary,
    EventListResponse,
    EventArchiveRequest
)
from .dependencies import get_current_user, get_current_workspace

# Router instance
router = APIRouter(
    prefix="/events",
    tags=["events"],
    responses={404: {"description": "Not found"}},
)


# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

def sanitize_folder_name(name: str) -> str:
    """
    Sanitize name for use as folder name
    Replaces spaces with underscores and removes special characters
    """
    folder_name = name.strip().replace(' ', '_')
    folder_name = ''.join(c for c in folder_name if c.isalnum() or c == '_')
    return folder_name


# ============================================================================
# CREATE
# ============================================================================

@router.post("/", response_model=EventResponse, status_code=status.HTTP_201_CREATED)
def create_event(
    event: EventCreate,
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    current_user: User = Depends(get_current_user),  # ✅ OAuth authentication
    db: Session = Depends(get_db)
):
    """
    Create a new event with automatic Google Drive folder
    
    ✅ OAuth Protected: Requires valid JWT token
    ✅ Workspace Isolated: Event is linked to workspace
    ✅ Ownership Verification: Checks if customer belongs to workspace
    ✅ User's Drive: Creates folder in authenticated user's Google Drive
    
    Args:
        event: Event data
        workspace: Current workspace (auto-injected)
        current_user: Authenticated user from JWT token
        
    Returns:
        Created event with google_drive_folder_id
    """
    
    # Verify customer exists AND belongs to this workspace
    customer = db.query(Customer).filter(
        Customer.customer_id == event.customer_id,
        Customer.workspace_id == workspace.workspace_id  # ✅ Verify customer in workspace
    ).first()
    
    if not customer:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Customer not found in your workspace"
        )
    
    # Check customer status
    if customer.status == "archived":
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Cannot create event for archived customer"
        )
    
    # Auto-generate folder_name if not provided
    if not event.folder_name:
        folder_name = sanitize_folder_name(event.event_name)
    else:
        folder_name = event.folder_name
    
    # Create event object
    db_event = Event(
        customer_id=event.customer_id,
        workspace_id=workspace.workspace_id,  # ✅ Link to workspace
        created_by_user_id=current_user.user_id,  # ✅ Track creator
        event_name=event.event_name,
        event_type=event.event_type,
        event_date=event.event_date,
        location_city=event.location_city,
        location_venue=event.location_venue,
        description=event.description,
        folder_name=folder_name,
        status=event.status or 'draft'
    )
    
    # Save to database first (to get event_id)
    db.add(db_event)
    db.commit()
    db.refresh(db_event)
    
    # ✅ TODO: Implement Google Drive folder creation using user's OAuth token
    # This will use the authenticated user's Google Drive, not a Service Account
    # Implementation will be added in Phase 2 after OAuth is fully working
    
    print(f"✅ Event created in workspace: {workspace.name}")
    print(f"   User: {current_user.email}")
    print(f"   Event: {event.event_name}")
    print(f"   Customer: {customer.company_name or customer.email}")
    print(f"   Event ID: {db_event.event_id}")
    
    return db_event


# ============================================================================
# READ - LIST
# ============================================================================

@router.get("/", response_model=EventListResponse)
def list_events(
    skip: int = Query(0, ge=0, description="Number of events to skip"),
    limit: int = Query(10, ge=1, le=100, description="Maximum events per page"),
    customer_id: Optional[UUID] = Query(None, description="Filter by customer_id"),
    status: Optional[str] = Query(None, description="Filter by status"),
    event_type: Optional[str] = Query(None, description="Filter by event type"),
    search: Optional[str] = Query(None, description="Search in event name and description"),
    include_archived: bool = Query(False, description="Include archived events"),
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Get list of events with pagination and filtering
    
    ✅ OAuth Protected: Only returns events from user's workspace
    ✅ Workspace Isolation: User can only see events in their workspace
    """
    
    # Base query - ONLY workspace's events
    query = db.query(Event).filter(
        Event.workspace_id == workspace.workspace_id  # ✅ Critical: Filter by workspace
    )
    
    # Filters
    if not include_archived:
        query = query.filter(Event.archived == False)
    
    if customer_id:
        # Verify customer belongs to workspace
        customer = db.query(Customer).filter(
            Customer.customer_id == customer_id,
            Customer.workspace_id == workspace.workspace_id
        ).first()
        
        if not customer:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Customer not found in your workspace"
            )
        
        query = query.filter(Event.customer_id == customer_id)
    
    if status:
        query = query.filter(Event.status == status)
    
    if event_type:
        query = query.filter(Event.event_type == event_type)
    
    if search:
        search_term = f"%{search}%"
        query = query.filter(
            or_(
                Event.event_name.ilike(search_term),
                Event.description.ilike(search_term),
                Event.location_city.ilike(search_term),
                Event.location_venue.ilike(search_term)
            )
        )
    
    # Get total count before pagination
    total = query.count()
    
    # Apply pagination
    events = query.order_by(Event.event_date.desc()).offset(skip).limit(limit).all()
    
    return EventListResponse(
        events=events,
        total=total,
        skip=skip,
        limit=limit
    )


# ============================================================================
# READ - SINGLE
# ============================================================================

@router.get("/{event_id}", response_model=EventResponse)
def get_event(
    event_id: UUID,
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Get a specific event by ID
    
    ✅ OAuth Protected: User can only access events in their workspace
    """
    event = db.query(Event).filter(
        Event.event_id == event_id,
        Event.workspace_id == workspace.workspace_id  # ✅ Verify workspace
    ).first()
    
    if not event:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Event not found in your workspace"
        )
    
    return event


# ============================================================================
# READ - SUMMARY
# ============================================================================

@router.get("/customer/{customer_id}/summary", response_model=List[EventSummary])
def get_customer_events_summary(
    customer_id: UUID,
    status: str = Query("active", description="Filter by status"),
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Get lightweight event list for dropdowns
    
    ✅ OAuth Protected: Only returns workspace's events
    ✅ Verifies customer in workspace
    """
    # Verify customer belongs to workspace
    customer = db.query(Customer).filter(
        Customer.customer_id == customer_id,
        Customer.workspace_id == workspace.workspace_id
    ).first()
    
    if not customer:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Customer not found in your workspace"
        )
    
    events = db.query(Event).filter(
        Event.customer_id == customer_id,
        Event.workspace_id == workspace.workspace_id,  # ✅ Workspace filter
        Event.status == status
    ).all()
    
    return [
        EventSummary(
            event_id=e.event_id,
            event_name=e.event_name,
            event_date=e.event_date,
            status=e.status
        )
        for e in events
    ]


# ============================================================================
# UPDATE
# ============================================================================

@router.put("/{event_id}", response_model=EventResponse)
def update_event(
    event_id: UUID,
    event_update: EventUpdate,
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Update an event
    
    ✅ OAuth Protected: User can only update events in their workspace
    """
    # Get event with workspace verification
    db_event = db.query(Event).filter(
        Event.event_id == event_id,
        Event.workspace_id == workspace.workspace_id  # ✅ Verify workspace
    ).first()
    
    if not db_event:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Event not found in your workspace"
        )
    
    # Update fields
    update_data = event_update.model_dump(exclude_unset=True)
    for field, value in update_data.items():
        setattr(db_event, field, value)
    
    db.commit()
    db.refresh(db_event)
    
    return db_event


# ============================================================================
# DELETE
# ============================================================================

@router.delete("/{event_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_event(
    event_id: UUID,
    hard_delete: bool = Query(False, description="Permanently delete (true) or soft delete (false)"),
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Delete an event
    
    ✅ OAuth Protected: User can only delete events in their workspace
    """
    db_event = db.query(Event).filter(
        Event.event_id == event_id,
        Event.workspace_id == workspace.workspace_id  # ✅ Verify workspace
    ).first()
    
    if not db_event:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Event not found in your workspace"
        )
    
    if hard_delete:
        db.delete(db_event)
    else:
        db_event.archived = True
    
    db.commit()
    return None


# ============================================================================
# ARCHIVE
# ============================================================================

@router.post("/{event_id}/archive", response_model=EventResponse)
def archive_event(
    event_id: UUID,
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Archive an event
    
    ✅ OAuth Protected: User can only archive events in their workspace
    """
    db_event = db.query(Event).filter(
        Event.event_id == event_id,
        Event.workspace_id == workspace.workspace_id  # ✅ Verify workspace
    ).first()
    
    if not db_event:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Event not found in your workspace"
        )
    
    db_event.archived = True
    db.commit()
    db.refresh(db_event)
    
    return db_event


# ============================================================================
# RESTORE
# ============================================================================

@router.post("/{event_id}/restore", response_model=EventResponse)
def restore_event(
    event_id: UUID,
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Restore an archived event
    
    ✅ OAuth Protected: User can only restore events in their workspace
    """
    db_event = db.query(Event).filter(
        Event.event_id == event_id,
        Event.workspace_id == workspace.workspace_id  # ✅ Verify workspace
    ).first()
    
    if not db_event:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Event not found in your workspace"
        )
    
    db_event.archived = False
    db.commit()
    db.refresh(db_event)
    
    return db_event


# ============================================================================
# UTILITY ENDPOINTS
# ============================================================================

@router.get("/customer/{customer_id}/list")
def list_customer_events(
    customer_id: UUID,
    include_archived: bool = Query(False, description="Include archived events"),
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Get all events for a customer (without pagination)
    
    ✅ OAuth Protected: Verifies customer in workspace
    
    Perfect for dropdowns and overview pages
    """
    # Verify customer belongs to workspace
    customer = db.query(Customer).filter(
        Customer.customer_id == customer_id,
        Customer.workspace_id == workspace.workspace_id
    ).first()
    
    if not customer:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Customer not found in your workspace"
        )
    
    # Query events
    query = db.query(Event).filter(
        Event.customer_id == customer_id,
        Event.workspace_id == workspace.workspace_id  # ✅ Workspace filter
    )
    
    if not include_archived:
        query = query.filter(Event.archived == False)
    
    events = query.order_by(Event.event_date.desc()).all()
    
    return {
        "customer_info": {
            "customer_id": str(customer.customer_id),
            "company_name": customer.company_name,
            "email": customer.email
        },
        "events": events,
        "total_count": len(events)
    }


@router.get("/{event_id}/with-customer")
def get_event_with_customer_details(
    event_id: UUID,
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    db: Session = Depends(get_db)
):
    """
    Get event WITH full customer information
    
    ✅ OAuth Protected: Verifies ownership of both event and customer
    
    Perfect for detail pages where you need both event and customer info
    """
    # Get event with workspace verification
    event = db.query(Event).filter(
        Event.event_id == event_id,
        Event.workspace_id == workspace.workspace_id
    ).first()
    
    if not event:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Event not found in your workspace"
        )
    
    # Get customer (already verified via workspace check)
    customer = db.query(Customer).filter(
        Customer.customer_id == event.customer_id
    ).first()
    
    return {
        "event": {
            "event_id": str(event.event_id),
            "event_name": event.event_name,
            "event_type": event.event_type,
            "event_date": event.event_date,
            "location_city": event.location_city,
            "location_venue": event.location_venue,
            "description": event.description,
            "status": event.status,
            "folder_name": event.folder_name,
            "google_drive_folder_id": event.google_drive_folder_id,
            "created_at": event.created_at,
            "updated_at": event.updated_at
        },
        "customer": {
            "customer_id": str(customer.customer_id),
            "company_name": customer.company_name,
            "first_name": customer.first_name,
            "last_name": customer.last_name,
            "email": customer.email,
            "phone": customer.phone,
            "google_drive_folder_id": customer.google_drive_folder_id
        }
    }


# ============================================================================
# STATISTICS
# ============================================================================

@router.get("/stats/overview")
def get_event_stats(
    workspace: Workspace = Depends(get_current_workspace),  # ✨ Workspace isolation
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    Get event statistics for current workspace
    
    ✅ OAuth Protected: Only shows stats for workspace's events
    """
    base_query = db.query(Event).filter(
        Event.workspace_id == workspace.workspace_id  # ✅ Workspace filter
    )
    
    total = base_query.count()
    draft = base_query.filter(Event.status == "draft").count()
    active = base_query.filter(Event.status == "active").count()
    completed = base_query.filter(Event.status == "completed").count()
    archived = base_query.filter(Event.archived == True).count()
    
    return {
        "total": total,
        "draft": draft,
        "active": active,
        "completed": completed,
        "archived": archived,
        "workspace_id": str(workspace.workspace_id),
        "workspace_name": workspace.name,
        "user_email": current_user.email
    }
